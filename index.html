<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VetorizaJá – PNG para SVG com IA</title>
    <link rel="icon" type="image/png" href="VetorizaJá.png">
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-N7MCHSTD1V"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-N7MCHSTD1V');
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/imagetracerjs@1.2.6/imagetracer_v1.2.6.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .hidden { display: none; }
        .loader { border-top-color: #2563eb; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">

    <header class="w-full h-28 px-8 flex justify-center md:justify-start items-center border-b border-slate-200 bg-white sticky top-0 z-50">
        <img src="VetorizaJá.png" alt="VetorizaJá" class="h-24 w-auto cursor-pointer object-contain" onclick="window.location.reload()">
    </header>

    <main class="max-w-6xl mx-auto px-6 py-12">
        <section id="hero-section" class="text-center py-10">
            <h1 class="text-5xl font-black mb-6 tracking-tight">Vetorize com <span class="text-blue-600">IA</span></h1>
            <div id="drop-zone" class="max-w-2xl mx-auto p-12 border-2 border-dashed border-slate-300 rounded-[40px] bg-white cursor-pointer relative shadow-xl">
                <input type="file" id="file-input" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" accept="image/png, image/jpeg">
                <div class="flex flex-col items-center">
                    <span class="text-2xl font-bold text-slate-800">Arraste sua imagem aqui</span>
                </div>
            </div>
        </section>

        <section id="preview-section" class="hidden grid lg:grid-cols-12 gap-10">
            <div class="lg:col-span-7 space-y-8">
                <div class="bg-white p-6 rounded-3xl border border-slate-100">
                    <span class="text-xs font-bold text-slate-400 uppercase">Resultado Vetorizado</span>
                    <div id="vector-container" class="relative bg-slate-50 rounded-2xl p-4 flex items-center justify-center min-h-[300px]">
                        <img id="img-vector-preview" src="" class="max-h-80 blur-lg" alt="Vetorizado">
                    </div>
                </div>
            </div>

            <div class="lg:col-span-5 bg-white p-10 rounded-[40px] shadow-2xl border border-slate-100">
                <h3 class="text-3xl font-black mb-2">Pagamento Pix</h3>
                <div id="payment-box">
                    <div class="bg-blue-600 text-white p-6 rounded-3xl mb-6 flex justify-between items-center">
                        <span class="font-bold">Valor</span>
                        <span class="text-3xl font-black">R$ 9,90</span>
                    </div>
                    <button id="btn-gerar-pix" onclick="gerarPix();" class="w-full bg-slate-900 text-white py-5 rounded-3xl font-black text-lg hover:bg-slate-800 transition-all">
                        Gerar QR Code Pix
                    </button>
                </div>

                <div id="pix-display" class="hidden space-y-6 text-center">
                    <div class="bg-white p-4 border-2 border-blue-100 rounded-3xl inline-block">
                        <img id="qr-code-img" src="" class="w-48 h-48 mx-auto" alt="QR Code Pix">
                    </div>
                    <p class="text-sm font-bold text-blue-600 animate-pulse">Aguardando pagamento...</p>
                    <button onclick="copyPix()" class="text-xs font-bold text-slate-500 underline">Copiar Código Pix</button>
                </div>

                <button id="btn-download" class="hidden w-full bg-green-600 text-white py-5 rounded-3xl font-black text-lg shadow-xl flex items-center justify-center gap-3">
                    Baixar SVG Agora
                </button>
            </div>
        </section>
    </main>

    <script>
        let svgData = '';
        let paymentId = null;
        let pixCopiaECola = '';

        const fileInput = document.getElementById('file-input');
        const heroSection = document.getElementById('hero-section');
        const previewSection = document.getElementById('preview-section');
        const imgOriginal = document.getElementById('img-original');
        const imgVectorPreview = document.getElementById('img-vector-preview');
        const btnDownload = document.getElementById('btn-download');
        const vectorContainer = document.getElementById('vector-container');

        fileInput.addEventListener('change', function(e) {
            if (e.target.files && e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    imgVectorPreview.src = event.target.result;
                    heroSection.classList.add('hidden');
                    previewSection.classList.remove('hidden');
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        });

        async function gerarPix() {
            document.getElementById('btn-gerar-pix').innerText = "Gerando...";
            try {
                const response = await fetch('/api/create-pix');
                const data = await response.json();
                paymentId = data.id;
                pixCopiaECola = data.qr_code;
                document.getElementById('qr-code-img').src = `data:image/jpeg;base64,${data.qr_code_base64}`;
                document.getElementById('payment-box').classList.add('hidden');
                document.getElementById('pix-display').classList.remove('hidden');
                
                // Inicia a verificação automática
                verificarPagamento();
            } catch (e) {
                alert("Erro ao gerar Pix. Tente novamente.");
            }
        }

        function copyPix() {
            navigator.clipboard.writeText(pixCopiaECola);
            alert("Código Pix copiado!");
        }

        async function verificarPagamento() {
            const interval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/check-payment?id=${paymentId}`);
                    const data = await response.json();

                    if (data.status === 'approved') {
                        clearInterval(interval);
                        liberarDownload();
                    }
                } catch (e) {
                    console.error("Erro ao verificar status");
                }
            }, 3000); // Verifica a cada 3 segundos
        }

        function liberarDownload() {
            document.getElementById('pix-display').innerHTML = "<p class='text-green-600 font-bold'>Pagamento Confirmado!</p>";
            ImageTracer.imageToSVG(imgVectorPreview.src, function(svgstr) {
                svgData = svgstr;
                imgVectorPreview.classList.add('hidden');
                vectorContainer.innerHTML = svgstr;
                const svgElement = vectorContainer.querySelector('svg');
                if(svgElement) svgElement.setAttribute('class', 'max-h-80 w-auto');
                btnDownload.classList.remove('hidden');
            }, 'posterized2');
        }

        btnDownload.onclick = function() {
            const blob = new Blob([svgData], { type: 'image/svg+xml' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'vetor-vetorizaja.svg';
            a.click();
        };
    </script>
</body>
</html>
